---
title: 数据库
date: 2022-03-05 +/-TTTT
categories: [数据库, MySQL]
tags: []     # TAG names should always be lowercase
---

# 数据库索引
1.索引是为了加快查询效率的一种数据结构，例如主键会自动加上唯一索引以加快查询效率（比如我们通常以主键为条件select）
2.唯一索引

- 任何与null比较的返回值都是null，包括null与null比较，但是带唯一约束的字段可以为null，但不能存在两个null，因为唯一约束规定null和null相同

2.外键

- 为了保证数据的一致性和正确性，我们往往会使用外键。例如1，在级联更新下，学生表中stu_id是主键，成绩表中stu_id是外键，如果在主表中stu_id发生变化，那么为了保证**一致性**从表中也会更新；例如2，当我们向成绩表中插入数据时，为了保证**正确性**会检查stu_id在学生表中是否存在，如果不存在则会插入失败；
- 添加外键索引
    + 创建成绩表时添加：`foreign key(stu_id) references t_student(stu_id)`；
    + 创建表后才添加：`ALTER TABLE t_score add constraint "t_score_fk1" foreign key(stu_id) references t_student(stu_id)`；
- 外键的优点
    + 保证了数据库数据的一致性和完整性；
    + 级联操作方便，减轻了程序代码量；
- 外键的缺点
    + 外键影响数据库的插入速度；
    + 级联更新是强阻塞，存在数据库更新风暴的风险；
- 使用外键存在的问题
    + 外键的主从关系是定的，但是需求确实变化的，如果字段不在需要与其他表关联就会增加麻烦；
    + 由于外键约束的存在，每次做级联更新和删除时都需要仔细考虑后果；
    + 外键还会因为需要请求对其他表内部加锁而容易出现死锁情况；
    + 对分库分表不友好 ：因为分库分表下外键是无法生效的；
- 外键的适用场景：外键与级联更新适用于单机低并发，不适合分布式、高并发集群；

# SQL
1.SQL语句

- 相比DML,DDL语句通常需要加上table关键词，例如：
```SQL
-- DDL
drop table t_user; 
truncate table t_user; 
alter table t_user ADD constraint foreign key(user_id) references t_score(user_id);

-- DML
select * from t_user;<!DOCTYPE html>
insert into t_user(id, username, password) values(1, "flameking", "123456");
update t_user set name="Casflawed",password="654321" where id=1;
```

- 相比truncate，delete语句在执行时会生成日志，以便回滚；而truncate会重置自增值，并恢复索引为初始大小；drop语句会直接清空表内存

2.WHERE子句

- where作为筛选语句会根据表记录从头到尾进行比较
- where 不可以使用字段的别名，having 可以。因为执行WHERE代码时，可能尚未确定列值。
- 在MySQL中，false也可以用0表示，true也可以用1表示

3.连接查询

- 即将两个表的字段连接起来

3.存储过程：预编译的SQL集合

- 优点：因为是预编译过的，因此执行速度会更快
- 难以调试和扩展

# 数据库设计
1.三大范式

- 第一范式：字段不可再分
- 第二范式：在第一范式的基础上，所有非主属性完全依赖主键
- 第三范式：在第二范式的基础上，所有非主属性直接依赖主键

2.ER图：实体关系图，适用它可以清楚的表示实体之间的关系，例如：由角色，和权限两种实体，其中一个角色可以拥有多条权限，而一条权限可以被不同的角色拥有，因此角色和权限之间是多对多的关系，另外还有一对一，一对多等关系

- 正方形表示实体
- 菱形表示关系实体
- 圆形表示实体属性

3.字符集

- 不同字符集能表示的字符范围不同，存储字符使用的字节数也不同
- Unicode 字符集是如今使用最多的一种字符集，它有多种编码实现，其中包括utf-8、utf-16、utf-32。
- 在数据库中对于utf-8有两套实现，分别是utf-8、utfmb4。而utfmb4能表示的字符范围更广、可以表示emoji字符以及一些复杂的汉字。
- 如果往CHARSET=utf-8的数据库中存入emoji字符会报错，因此应该使用utfmb4字符集。

# 数据库事务
1.事务ACID特性：以MySQL的InnoDB存储引擎为例

- A：原子性（atom），即以事务为最小单位，事务内的所有操作要么都成功要么都失败；依靠回滚日志（undo log）实现
- I：隔离性（Isolation），并发事务不会互相影响；依靠锁机制和MVCC实现
- D：持久性（durable），事务执行成功后对数据产生的影响是持久的，及时数据库发生故障，影响依然存在；依靠重做日志（redo log）实现
- C：一致性（consistency），即事务执行前后，数据依然保持逻辑一致性，这个逻辑一致性一般符合现实逻辑，或由DBA指定的规则；上述三者实现后，一致性才能实现

2.事务并发产生的响应

- 幻读和不可重复读的区别：不可重复读在于对同一条表记录进行多次查询时发现某些列被改变，而幻读在于多次查询时发现记录增加或者减少了。

3.MySQL的默认事务隔离级别

- 命令行查看方式
```SQL
select @@tx_isolation;
```
- InnoDB默认隔离级别是repeatable-read，需要应用加锁读实现，这个加锁实现依靠的就是next-key Locks（兼具记录锁和间隙锁的特点，既锁行又锁范围）
- InnoDB 存储引擎在分布式事务的情况下一般会用到 SERIALIZABLE(可串行化) 隔离级别。