---
title: 多表查询
date: 2022-06-19 +/-TTTT
categories: [数据库, MySQL]
tags: []     # TAG names should always be lowercase
---

# 多表关系
项目开发中，在进行数据库表结构设计时，会根据业务需求及业务模块之间关系，分析并设计表结构，由于业务之间相互关联，所以各个表结构之间也存在着各种联系，基本分为三种：

- 一对多（多对一）
- 多对多
- 一对一

## 一对多

案例：部门与员工<br>
关系：一个部门对应多个员工，一个员工对应一个部门<br>
实现：在多的一方建立外键，指向一的一方的主键<br>
![一对多](/blog/202206191717349.png "一对多")

## 多对多

案例：学生与课程<br>
关系：一个学生可以选多门课程，一门课程也可以供多个学生选修<br>
实现：建立第三张中间表，中间表至少包含两个外键，分别关联两方主键<br>
![多对多](/blog/202206191720729.png "多对多")

## 一对一

案例：用户与用户详情<br>
关系：一对一关系，多用于单表拆分，将一张表的基础字段放在一张表中，其他详情字段放在另一张表中，以提升操作效率<br>
实现：在任意一方加入外键，关联另外一方的主键，并且设置外键为唯一的（UNIQUE）<br>
![一对一](/blog/202206191728437.png "一对一")

# 多表查询
概述：指从多张表中查询数据<br>
笛卡尔积：两个集合，A集合和B集合的所有组合情况，如：`select * from employee, dept;`（在多表查询时，需要消除无效的笛卡尔积）<br>
![笛卡尔积](/blog/202206191737026.png "笛卡尔积")

消除无效笛卡尔积：
`select * from employee, dept where employee.dept = dept.id;`

## 内连接查询
内连接也被称为相等连接或简单连接，它是把两张表中满足on子句中搜索条件/where子句搜索条件的行连接起来或者说把两张表中相关的行连接起来（**注意：搜索条件中指定的列都会被显示，并不是说被合并成一列）**

> 隐式内连接：
> `SELECT 字段列表 FROM 表1, 表2 WHERE 条件 ...;`<br>
> 显式内连接：
> `SELECT 字段列表 FROM 表1 [ INNER ] JOIN 表2 ON 连接条件 ...;`<br>
> 显式性能比隐式高

例子：

表结构如下：<br>
![案例表结构](/blog/202206191755126.png "案例表结构")

```mysql
-- 查询员工姓名，及关联的部门的名称
-- 隐式
select e.name, d.name from employee as e, dept as d where e.dept = d.id;
-- 显式
select e.name, d.name from employee as e inner join dept as d on e.dept = d.id;
```

## 外连接查询

左外连接：两张表中满足on子句中搜索条件的行连接起来以及左表所有数据，`SELECT 字段列表 FROM 表1 LEFT [ OUTER ] JOIN 表2 ON 条件 ...;`在这个格式中表1就是左表<br>
右外连接：两张表中满足on子句中搜索条件的行连接起来以及右表所有数据，`SELECT 字段列表 FROM 表1 RIGHT [ OUTER ] JOIN 表2 ON 条件 ...;`

例子：

```mysql
-- 左
select e.*, d.name from employee e left join dept d on e.dept = d.id;
-- 右
select d.name, e.* from employee e right join dept d on e.dept = d.id;
```
 
**内连接和外连接的区别：外连接有个明显的特点，就是不管满不满足on子句搜索条件，左表或右表的数据会全部查询，而内连接中要是不相关的行就不会被查询**

## 自连接查询

当前表与自身的连接查询，自连接必须使用表别名，**如何理解内连接：内连接是自己于自己连接，也就是行与行之间是有相关逻辑的，例如下面例子中行与行之间可以通过id和manager两个字段联系起来，因此我们也可以将其看作两张不同的表，其中manager是从表中的外键，id是主表中的主键，这样一来就可作为内连接或外连接理解了**<br>
语法：`SELECT 字段列表 FROM 表A 别名A JOIN 表A 别名B ON 条件 ...;`，自连接查询，可以是内连接查询，也可以是外连接查询

例子：

```mysql
-- 查询员工及其所属领导的名字
select a.name, b.name from employee a, employee b where a.manager = b.id;
-- 没有领导的也查询出来
select a.name, b.name from employee a left join employee b on a.manager = b.id;
```

## 联合查询 union, union all

把多次查询的结果合并，形成一个新的查询集

语法：

```mysql
SELECT 字段列表 FROM 表A ...
UNION [ALL]
SELECT 字段列表 FROM 表B ...
```
**注意：<br>
1.进行联合查询的多张表的列数必须相等，字段类型也需要保持一致<br>
2.相比于UNION ALL，UNION会对合并的结果集去重<br>
3.联合查询比使用or效率高，不会使索引失效**